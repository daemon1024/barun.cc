<svg xmlns="http://www.w3.org/2000/svg" width="800" height="420" font-family="monospace, sans-serif" font-size="13">
  <rect width="800" height="420" fill="white"/>

  <!-- Title -->
  <text x="400" y="30" text-anchor="middle" font-size="15" font-weight="bold" fill="#111">The Thread Pool Context Problem</text>

  <!-- Request Thread box -->
  <rect x="60" y="55" width="200" height="70" rx="6" fill="#e8f4fd" stroke="#2196F3" stroke-width="1.5"/>
  <text x="160" y="78" text-anchor="middle" font-weight="bold" fill="#1565C0">Request Thread</text>
  <text x="160" y="96" text-anchor="middle" fill="#1565C0">TID: 1001</text>
  <text x="160" y="114" text-anchor="middle" fill="#1565C0">[ active span ctx ]</text>

  <!-- sys_clone arrow -->
  <line x1="160" y1="125" x2="160" y2="160" stroke="#555" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="170" y="148" fill="#555" font-size="11">sys_clone ×3</text>

  <!-- Worker boxes -->
  <rect x="20" y="165" width="140" height="55" rx="6" fill="#fff3e0" stroke="#FF9800" stroke-width="1.5"/>
  <text x="90" y="188" text-anchor="middle" font-weight="bold" fill="#E65100">Worker B</text>
  <text x="90" y="206" text-anchor="middle" fill="#E65100">TID: 1002</text>

  <rect x="180" y="165" width="140" height="55" rx="6" fill="#fff3e0" stroke="#FF9800" stroke-width="1.5"/>
  <text x="250" y="188" text-anchor="middle" font-weight="bold" fill="#E65100">Worker C</text>
  <text x="250" y="206" text-anchor="middle" fill="#E65100">TID: 1003</text>

  <!-- Write syscall arrow from Worker B -->
  <line x1="90" y1="220" x2="90" y2="268" stroke="#F44336" stroke-width="1.5" marker-end="url(#arrowred)" stroke-dasharray="5,3"/>
  <text x="100" y="252" fill="#F44336" font-size="11">write()</text>

  <!-- eBPF probe box -->
  <rect x="20" y="272" width="300" height="65" rx="6" fill="#fce4ec" stroke="#E91E63" stroke-width="1.5"/>
  <text x="170" y="295" text-anchor="middle" font-weight="bold" fill="#880E4F">eBPF Log Capture Probe</text>
  <text x="170" y="313" text-anchor="middle" fill="#880E4F">lookup(TID=1002) → span_map</text>
  <text x="170" y="331" text-anchor="middle" fill="#C62828">✗  NOT FOUND</text>

  <!-- span_map -->
  <rect x="420" y="55" width="200" height="100" rx="6" fill="#f3e5f5" stroke="#9C27B0" stroke-width="1.5"/>
  <text x="520" y="78" text-anchor="middle" font-weight="bold" fill="#4A148C">span_map</text>
  <text x="520" y="96" text-anchor="middle" fill="#4A148C" font-size="11">TID → span_context</text>
  <line x1="430" y1="108" x2="610" y2="108" stroke="#9C27B0" stroke-width="0.8"/>
  <text x="520" y="124" text-anchor="middle" fill="#4A148C">1001 → {traceID, spanID}</text>
  <text x="520" y="142" text-anchor="middle" fill="#9e9e9e">1002 → ???</text>

  <!-- Arrow from Request Thread to span_map -->
  <line x1="260" y1="90" x2="418" y2="90" stroke="#9C27B0" stroke-width="1.5" marker-end="url(#arrowpurple)"/>
  <text x="340" y="82" text-anchor="middle" fill="#9C27B0" font-size="11">registers span</text>

  <!-- Arrow from probe to span_map (miss) -->
  <line x1="320" y1="305" x2="418" y2="130" stroke="#F44336" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowred)"/>
  <text x="390" y="230" fill="#F44336" font-size="11" transform="rotate(-55 390 230)">lookup miss</text>

  <!-- Legend / caption -->
  <text x="400" y="395" text-anchor="middle" fill="#757575" font-size="11">Worker threads are spawned from Request Thread but span context is registered under TID 1001.</text>
  <text x="400" y="412" text-anchor="middle" fill="#757575" font-size="11">Any write() call from a worker results in a span_map miss — log goes uncorrelated.</text>

  <defs>
    <marker id="arrow" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#555"/>
    </marker>
    <marker id="arrowred" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#F44336"/>
    </marker>
    <marker id="arrowpurple" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#9C27B0"/>
    </marker>
  </defs>
</svg>
